---
layout: page
title:  Организация памяти виртуальной машины Ol
date:   Sat 28 Nov 2015 01:29:07 AM EET
categories: en
---
   Виртуальная машина Ol (olvm) является регистровой (R) виртуальной машиной, использующей для долговременного хранения данных динамическую кучу (Heap) под управлением сборщика мусора (Garbage collector, GC).

   Все данные, которыми оперирует виртуальная машина Ol (olvm), как и в большинстве других языков программирования с динамической типизацией, делятся на два типа - value тип и reference тип.

   Значения value типа представляют собой непосредственные значения, reference типа - указатели на объекты, размещаемые в памяти. Объекты никогда не передаются по значению, только по ссылке. Value значения никогда не передаются по ссылке, только по значению.

### Регистры

   Регистров у виртуальной машины в насчитывается 128. Это число зависит от реализации olvm и задается в lang/register.scm как (define n-registers 128) и src/olvm.c как #define NR 128. Значения регистров программисту непосредственно недоступны.

   В регистрах хранятся либо ссылки на размещенные в куче объекты, либо непосредственные значения - такие как небольшие числа (укладывающиеся в количество бит машинного слова минус 8), константы #true, #false, #null, #empty и другие.

   В процессе сборки мусора (gc, о ней чуть позже) именно значения регистров являются тем корнем, от которого начинает работать сборщик мусора. Значения регистров складываются в куче в отдельный кортеж (tuple), который назначается корнем сборки. После сборки регистры восстанавливаются из кортежа и кортеж уничтожается.
Пример кода, который это делает:
<pre><code>
    int p = 0, N = NR;
    word *regs = (word*) new_tuple (N + 1);
    while (++p <= N) regs[p] = R[p-1];
    regs[p] = (word) this;

    heap.fp = fp;
    regs = (word*) gc(&heap, size, (word)regs);
    fp = heap.fp;

    this = (word *) regs[p];
    while (--p >= 1) R[p-1] = regs[p];
    fp = regs; // удалим созданный выше tuple
</code></pre>

### Куча

   Память Ol, или "куча" (Heap), представляет собой динамически изменяемый линейный массив объектов, управляюемый сборщиком мусора (Garbage Collector, GC). Ничего кроме объектов в куче разместить нельзя.

